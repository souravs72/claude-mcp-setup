FROM mcp-servers/base:latest

# Copy specific requirements
COPY requirements/goal_agent_requirements.txt /app/requirements/
RUN pip install --no-cache-dir -r requirements/goal_agent_requirements.txt

# Copy database module
COPY servers/database.py /app/servers/

# Copy server code
COPY servers/goal_agent_server.py /app/servers/

# Create data directory
RUN mkdir -p /app/data/goals && chown appuser:appuser /app/data/goals

# Expose port
EXPOSE 8002

# Environment variables
ENV PYTHONUNBUFFERED=1
ENV POSTGRES_HOST=localhost
ENV POSTGRES_PORT=5432
ENV POSTGRES_DB=mcp_goals
ENV POSTGRES_USER=postgres
ENV GOAL_AGENT_MAX_WORKERS=10

# Run database migrations on startup, then server
CMD python scripts/init_database.py && \
    python -m uvicorn servers.goal_agent_server:app --host 0.0.0.0 --port 8002

