<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP Operations Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        @keyframes pulse-slow {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .animate-pulse-slow {
            animation: pulse-slow 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        .status-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 6px;
        }
        .status-running { background-color: #10b981; }
        .status-stopped { background-color: #ef4444; }
        .status-warning { background-color: #f59e0b; }

        .log-error { color: #ef4444; }
        .log-warning { color: #f59e0b; }
        .log-info { color: #6b7280; }
        .log-debug { color: #8b5cf6; }

        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #1f2937;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
        }
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: #1f2937;
            border: 1px solid #374151;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        /* Button styles */
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }
        .btn-primary {
            background-color: #3b82f6;
            color: white;
        }
        .btn-primary:hover {
            background-color: #2563eb;
        }
        .btn-success {
            background-color: #10b981;
            color: white;
        }
        .btn-success:hover {
            background-color: #059669;
        }
        .btn-danger {
            background-color: #ef4444;
            color: white;
        }
        .btn-danger:hover {
            background-color: #dc2626;
        }
        .btn-warning {
            background-color: #f59e0b;
            color: white;
        }
        .btn-warning:hover {
            background-color: #d97706;
        }
        .btn-secondary {
            background-color: #6b7280;
            color: white;
        }
        .btn-secondary:hover {
            background-color: #4b5563;
        }
        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }

        /* Tab styles */
        .tab {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        .tab:hover {
            background-color: #374151;
        }
        .tab.active {
            border-bottom-color: #3b82f6;
            color: #3b82f6;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    <!-- Header -->
    <header class="bg-gray-800 border-b border-gray-700">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="text-2xl font-bold bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent">
                        MCP Operations Console
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="status-dot animate-pulse-slow" id="status-indicator"></span>
                        <span class="text-sm text-gray-400" id="connection-status">Connecting...</span>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-sm text-gray-400" id="last-update">Last update: --:--</div>
                    <button onclick="refreshData()" class="btn btn-primary">
                        Refresh
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-6 py-8">
        <!-- Overview Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Servers Card -->
            <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-sm font-medium text-gray-400">Servers</h3>
                    <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01"></path>
                    </svg>
                </div>
                <div class="text-3xl font-bold text-white" id="servers-running">0/0</div>
                <div class="text-sm text-gray-400 mt-1">Running</div>
            </div>

            <!-- Redis Card -->
            <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-sm font-medium text-gray-400">Redis Cache</h3>
                    <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"></path>
                    </svg>
                </div>
                <div class="text-3xl font-bold text-white" id="redis-keys">--</div>
                <div class="text-sm text-gray-400 mt-1" id="redis-status">Status</div>
            </div>

            <!-- Goals Card -->
            <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-sm font-medium text-gray-400">Active Goals</h3>
                    <svg class="w-5 h-5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                    </svg>
                </div>
                <div class="text-3xl font-bold text-white" id="goals-active">0</div>
                <div class="text-sm text-gray-400 mt-1" id="goals-status">Total goals</div>
            </div>

            <!-- System Card -->
            <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-sm font-medium text-gray-400">System Load</h3>
                    <svg class="w-5 h-5 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                </div>
                <div class="text-3xl font-bold text-white" id="system-cpu">--</div>
                <div class="text-sm text-gray-400 mt-1">CPU Usage</div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="bg-gray-800 rounded-t-xl border border-gray-700 border-b-0 overflow-hidden mb-0">
            <div class="flex space-x-1 px-2">
                <div class="tab active" onclick="switchTab('servers')">üñ•Ô∏è Servers</div>
                <div class="tab" onclick="switchTab('redis')">üíæ Redis Cache</div>
                <div class="tab" onclick="switchTab('goals')">üéØ Goals & Tasks</div>
                <div class="tab" onclick="switchTab('logs')">üìù Logs</div>
                <div class="tab" onclick="switchTab('env')">‚öôÔ∏è Environment</div>
            </div>
        </div>

        <!-- Tab Contents -->
        <div class="bg-gray-800 rounded-b-xl border border-gray-700 p-6">
            <!-- Servers Tab -->
            <div id="tab-servers" class="tab-content active">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold">Server Management</h2>
                    <div class="space-x-2">
                        <button onclick="controlAllServers('start')" class="btn btn-success">Start All</button>
                        <button onclick="controlAllServers('restart')" class="btn btn-warning">Restart All</button>
                        <button onclick="controlAllServers('stop')" class="btn btn-danger">Stop All</button>
                    </div>
                </div>
                <div class="space-y-4" id="servers-list">
                    <div class="text-center text-gray-400 py-8">Loading...</div>
                </div>
            </div>

            <!-- Redis Tab -->
            <div id="tab-redis" class="tab-content">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold">Redis Cache Management</h2>
                    <div class="space-x-2">
                        <button onclick="showAddKeyModal()" class="btn btn-success">Add Key</button>
                        <button onclick="confirmFlushRedis()" class="btn btn-danger">Flush All</button>
                    </div>
                </div>

                <div class="mb-4">
                    <input type="text" id="redis-search" placeholder="Search keys (use * for wildcards)"
                           class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white"
                           onkeyup="searchRedisKeys(event)">
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-sm font-medium text-gray-400 mb-4">Redis Statistics</h3>
                        <div id="redis-stats">
                            <div class="text-center text-gray-400 py-8">Click here to load Redis statistics</div>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-sm font-medium text-gray-400 mb-4">Keys</h3>
                        <div class="space-y-2 max-h-96 overflow-y-auto custom-scrollbar" id="redis-keys-list">
                            <div class="text-center text-gray-400 py-8">Redis keys will appear here</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Goals Tab -->
            <div id="tab-goals" class="tab-content">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold">Goals & Tasks Management</h2>
                    <button onclick="showCreateGoalModal()" class="btn btn-success">Create Goal</button>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-sm font-medium text-gray-400 mb-4">All Goals</h3>
                        <div class="space-y-3 max-h-96 overflow-y-auto custom-scrollbar" id="all-goals-list">
                            <div class="text-center text-gray-400 py-8">Click to view goals</div>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-sm font-medium text-gray-400 mb-4">All Tasks</h3>
                        <div class="space-y-3 max-h-96 overflow-y-auto custom-scrollbar" id="all-tasks-list">
                            <div class="text-center text-gray-400 py-8">Click to view tasks</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Logs Tab -->
            <div id="tab-logs" class="tab-content">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold">Server Logs</h2>
                    <div class="flex space-x-2">
                        <select id="log-server-filter" class="px-3 py-1 bg-gray-700 border border-gray-600 rounded-lg text-sm text-gray-300">
                            <option value="all">All Servers</option>
                        </select>
                        <button onclick="downloadLogs()" class="btn btn-primary btn-sm">Download</button>
                        <button onclick="clearLogs()" class="btn btn-danger btn-sm">Clear</button>
                    </div>
                </div>
                <div class="bg-gray-900 rounded-lg p-4 font-mono text-xs max-h-96 overflow-y-auto custom-scrollbar" id="logs-container">
                    <div class="text-center text-gray-500 py-8">Loading logs...</div>
                </div>
            </div>

            <!-- Environment Tab -->
            <div id="tab-env" class="tab-content">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold">Environment Variables</h2>
                </div>
                <div class="space-y-4" id="env-list">
                    <div class="text-center text-gray-400 py-8">Click to view environment configuration</div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 border-t border-gray-700 mt-12">
        <div class="container mx-auto px-6 py-4">
            <div class="text-center text-sm text-gray-400">
                MCP Operations Dashboard v1.0.0 | Real-time updates via WebSocket
            </div>
        </div>
    </footer>

    <!-- Modals -->
    <!-- Add Redis Key Modal -->
    <div id="addKeyModal" class="modal">
        <div class="modal-content">
            <div class="p-6 border-b border-gray-700">
                <h3 class="text-lg font-bold">Add Redis Key</h3>
            </div>
            <div class="p-6">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Key</label>
                        <input type="text" id="new-key-name" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white" placeholder="key_name">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Value</label>
                        <textarea id="new-key-value" rows="4" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white" placeholder="value"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">TTL (seconds, optional)</label>
                        <input type="number" id="new-key-ttl" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white" placeholder="Leave empty for no expiration">
                    </div>
                </div>
            </div>
            <div class="p-6 border-t border-gray-700 flex justify-end space-x-2">
                <button onclick="closeModal('addKeyModal')" class="btn btn-secondary">Cancel</button>
                <button onclick="addRedisKey()" class="btn btn-primary">Add Key</button>
            </div>
        </div>
    </div>

    <!-- View/Edit Redis Key Modal -->
    <div id="viewKeyModal" class="modal">
        <div class="modal-content">
            <div class="p-6 border-b border-gray-700">
                <h3 class="text-lg font-bold">Key Details</h3>
            </div>
            <div class="p-6">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Key</label>
                        <div class="px-3 py-2 bg-gray-700 rounded-lg text-white font-mono text-sm" id="view-key-name"></div>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Type</label>
                        <div class="px-3 py-2 bg-gray-700 rounded-lg text-white" id="view-key-type"></div>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">TTL</label>
                        <div class="px-3 py-2 bg-gray-700 rounded-lg text-white" id="view-key-ttl"></div>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Value</label>
                        <pre class="px-3 py-2 bg-gray-700 rounded-lg text-white font-mono text-xs overflow-x-auto" id="view-key-value"></pre>
                    </div>
                </div>
            </div>
            <div class="p-6 border-t border-gray-700 flex justify-end space-x-2">
                <button onclick="closeModal('viewKeyModal')" class="btn btn-secondary">Close</button>
                <button onclick="deleteKey()" class="btn btn-danger">Delete</button>
            </div>
        </div>
    </div>

    <!-- Create Goal Modal -->
    <div id="createGoalModal" class="modal">
        <div class="modal-content">
            <div class="p-6 border-b border-gray-700">
                <h3 class="text-lg font-bold">Create New Goal</h3>
            </div>
            <div class="p-6">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Description</label>
                        <textarea id="new-goal-description" rows="3" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white" placeholder="Goal description"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Priority</label>
                        <select id="new-goal-priority" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
                            <option value="low">Low</option>
                            <option value="medium" selected>Medium</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="p-6 border-t border-gray-700 flex justify-end space-x-2">
                <button onclick="closeModal('createGoalModal')" class="btn btn-secondary">Cancel</button>
                <button onclick="createGoal()" class="btn btn-primary">Create</button>
            </div>
        </div>
    </div>

    <!-- View Goal Details Modal -->
    <div id="viewGoalModal" class="modal">
        <div class="modal-content max-w-4xl">
            <div class="p-6 border-b border-gray-700 flex justify-between items-center">
                <h3 class="text-lg font-bold" id="goal-detail-title">Goal Details</h3>
                <span class="px-3 py-1 rounded text-sm" id="goal-detail-status-badge"></span>
            </div>
            <div class="p-6 max-h-[70vh] overflow-y-auto">
                <!-- Goal Information -->
                <div class="bg-gray-700 rounded-lg p-4 mb-6">
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-xs text-gray-400 mb-1">Goal ID</label>
                            <div class="font-mono text-sm" id="goal-detail-id"></div>
                        </div>
                        <div>
                            <label class="block text-xs text-gray-400 mb-1">Priority</label>
                            <div class="text-sm" id="goal-detail-priority"></div>
                        </div>
                        <div>
                            <label class="block text-xs text-gray-400 mb-1">Created</label>
                            <div class="text-sm" id="goal-detail-created"></div>
                        </div>
                        <div>
                            <label class="block text-xs text-gray-400 mb-1">Updated</label>
                            <div class="text-sm" id="goal-detail-updated"></div>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs text-gray-400 mb-1">Description</label>
                        <div class="text-sm" id="goal-detail-description"></div>
                    </div>
                </div>

                <!-- Task Summary -->
                <div class="mb-4">
                    <h4 class="text-sm font-bold text-gray-300 mb-3">Tasks Summary</h4>
                    <div class="grid grid-cols-4 gap-3">
                        <div class="bg-gray-700 rounded p-3 text-center">
                            <div class="text-2xl font-bold text-gray-300" id="task-count-pending">0</div>
                            <div class="text-xs text-gray-400">Pending</div>
                        </div>
                        <div class="bg-gray-700 rounded p-3 text-center">
                            <div class="text-2xl font-bold text-blue-400" id="task-count-progress">0</div>
                            <div class="text-xs text-gray-400">In Progress</div>
                        </div>
                        <div class="bg-gray-700 rounded p-3 text-center">
                            <div class="text-2xl font-bold text-green-400" id="task-count-completed">0</div>
                            <div class="text-xs text-gray-400">Completed</div>
                        </div>
                        <div class="bg-gray-700 rounded p-3 text-center">
                            <div class="text-2xl font-bold text-red-400" id="task-count-cancelled">0</div>
                            <div class="text-xs text-gray-400">Cancelled</div>
                        </div>
                    </div>
                </div>

                <!-- Tasks List -->
                <div>
                    <h4 class="text-sm font-bold text-gray-300 mb-3">All Tasks</h4>
                    <div id="goal-detail-tasks" class="space-y-2">
                        <div class="text-center text-gray-400 py-4">No tasks</div>
                    </div>
                </div>
            </div>
            <div class="p-6 border-t border-gray-700 flex justify-end">
                <button onclick="closeModal('viewGoalModal')" class="btn btn-secondary">Close</button>
            </div>
        </div>
    </div>

    <!-- Edit Environment Variable Modal -->
    <div id="editEnvModal" class="modal">
        <div class="modal-content">
            <div class="p-6 border-b border-gray-700">
                <h3 class="text-lg font-bold">Edit Environment Variable</h3>
            </div>
            <div class="p-6">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Variable Name</label>
                        <div class="px-3 py-2 bg-gray-700 rounded-lg text-white font-mono text-sm" id="edit-env-name"></div>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Value</label>
                        <div class="relative">
                            <input type="password" id="edit-env-value" class="w-full px-3 py-2 pr-10 bg-gray-700 border border-gray-600 rounded-lg text-white font-mono" placeholder="Enter value">
                            <button onclick="toggleEnvValueVisibility()" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-white">
                                <svg id="eye-icon-open" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                </svg>
                                <svg id="eye-icon-closed" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"></path>
                                </svg>
                            </button>
                        </div>
                        <p class="text-xs text-gray-400 mt-1">‚ö†Ô∏è Changes will be saved to .env file and affect all servers</p>
                    </div>
                </div>
            </div>
            <div class="p-6 border-t border-gray-700 flex justify-end space-x-2">
                <button onclick="closeModal('editEnvModal')" class="btn btn-secondary">Cancel</button>
                <button onclick="saveEnvVariable()" class="btn btn-primary">Save</button>
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="toast" class="fixed bottom-4 right-4 bg-gray-800 border border-gray-700 rounded-lg p-4 shadow-lg min-w-64 max-w-md" style="display: none; z-index: 9999;">
        <div id="toast-message" class="text-white text-sm"></div>
    </div>

    <script>
        let ws = null;
        let reconnectTimeout = null;
        let currentTab = 'servers';
        let currentViewKey = null;
        let reconnectAttempts = 0;
        const MAX_RECONNECT_DELAY = 30000; // Max 30 seconds between reconnects

        // WebSocket Connection Management
        function connectWebSocket() {
            // Clean up existing connection
            if (ws) {
                ws.close();
            }

            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;

            console.log('Connecting to WebSocket:', wsUrl);
            updateStatusIndicator(false);
            document.getElementById('connection-status').textContent = 'Connecting...';

            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                console.log('‚úì WebSocket connected');
                reconnectAttempts = 0;
                updateStatusIndicator(true);
                document.getElementById('connection-status').textContent = 'Connected (Live)';

                // Clear any pending reconnection attempts
                if (reconnectTimeout) {
                    clearTimeout(reconnectTimeout);
                    reconnectTimeout = null;
                }
            };

            ws.onmessage = (event) => {
                try {
                    const message = JSON.parse(event.data);
                    handleWebSocketMessage(message);
                } catch (error) {
                    console.error('Error parsing WebSocket message:', error);
                }
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                updateStatusIndicator(false);
            };

            ws.onclose = () => {
                console.log('‚úó WebSocket disconnected');
                updateStatusIndicator(false);
                document.getElementById('connection-status').textContent = 'Disconnected';

                // Attempt to reconnect with exponential backoff
                scheduleReconnect();
            };
        }

        function scheduleReconnect() {
            if (reconnectTimeout) {
                return; // Already scheduled
            }

            reconnectAttempts++;
            // Exponential backoff: 1s, 2s, 4s, 8s, ... up to MAX_RECONNECT_DELAY
            const delay = Math.min(1000 * Math.pow(2, reconnectAttempts - 1), MAX_RECONNECT_DELAY);

            console.log(`Reconnecting in ${delay / 1000}s (attempt ${reconnectAttempts})`);
            document.getElementById('connection-status').textContent = `Reconnecting in ${Math.ceil(delay / 1000)}s...`;

            reconnectTimeout = setTimeout(() => {
                reconnectTimeout = null;
                connectWebSocket();
            }, delay);
        }

        function handleWebSocketMessage(message) {
            const { type, data, timestamp } = message;

            switch (type) {
                case 'initial':
                case 'update':
                    // Update UI with new data
                    if (data.status) {
                        updateStatusCards(data.status);
                    }
                    if (data.servers) {
                        renderServers(data.servers.servers);
                    }
                    if (data.goals) {
                        updateGoalsCards(data.goals);
                    }
                    if (data.logs) {
                        renderLogs(data.logs);
                    }

                    // Update timestamp
                    if (timestamp) {
                        const date = new Date(timestamp);
                        document.getElementById('last-update').textContent =
                            `Last update: ${date.toLocaleTimeString()}`;
                    }
                    break;

                case 'ping':
                    // Server keepalive ping, send pong back
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify({ type: 'pong' }));
                    }
                    break;

                default:
                    console.log('Unknown message type:', type);
            }
        }

        // Store last known values to prevent flickering
        let lastKnownSystemCpu = '--';

        function updateStatusCards(status) {
            // Always update: Server counts
            document.getElementById('servers-running').textContent =
                `${status.servers.running}/${status.servers.total}`;

            // Always update: Redis key count and connection status
            document.getElementById('redis-keys').textContent =
                status.redis.connected && status.redis.total_keys !== undefined
                    ? status.redis.total_keys
                    : 'N/A';
            document.getElementById('redis-status').textContent =
                status.redis.connected ? 'Connected' : 'Disconnected';

            // Only update system stats when included (every 1000ms)
            // Otherwise preserve last known value to prevent flickering
            if (status.system && status.system.cpu_percent !== undefined) {
                lastKnownSystemCpu = `${status.system.cpu_percent.toFixed(1)}%`;
            }
            document.getElementById('system-cpu').textContent = lastKnownSystemCpu;
        }

        function updateGoalsCards(goalsData) {
            const summary = goalsData.summary;
            document.getElementById('goals-active').textContent =
                summary.goals_by_status.in_progress + summary.goals_by_status.pending;
            document.getElementById('goals-status').textContent =
                `${summary.total_goals} total`;
        }

        // Manual refresh - requests fresh data from server via WebSocket
        function refreshData() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'refresh' }));
                console.log('Requested manual refresh via WebSocket');
            } else {
                // Fallback to HTTP if WebSocket not available
                console.log('WebSocket not available, using HTTP fallback');
                fallbackRefresh();
            }
        }

        // Fallback refresh using HTTP (only used when WebSocket is down)
        async function fallbackRefresh() {
            try {
                const statusResponse = await fetch('/api/status');
                const status = await statusResponse.json();
                updateStatusCards(status);

                const serversResponse = await fetch('/api/servers');
                const servers = await serversResponse.json();
                renderServers(servers.servers);

                const goalsResponse = await fetch('/api/goals');
                const goals = await goalsResponse.json();
                updateGoalsCards({ summary: goals.summary });

                const logsResponse = await fetch('/api/logs?lines=30');
                const logs = await logsResponse.json();
                renderLogs(logs);

                const now = new Date();
                document.getElementById('last-update').textContent =
                    `Last update: ${now.toLocaleTimeString()} (HTTP)`;

                updateStatusIndicator(true);
            } catch (error) {
                console.error('Failed to refresh data:', error);
                updateStatusIndicator(false);
            }
        }

        // Tab switching
        function switchTab(tab) {
            currentTab = tab;

            // Update tab buttons
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.tab[onclick="switchTab('${tab}')"]`).classList.add('active');

            // Update tab contents
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');

            // Load tab-specific data
            if (tab === 'redis') {
                loadRedisData();
            } else if (tab === 'goals') {
                loadAllGoals();
                loadAllTasks();
            } else if (tab === 'env') {
                loadEnvVariables();
            }
        }

        // Load complete Redis tab data
        async function loadRedisData() {
            await loadRedisStats();
            await loadRedisKeys();
        }

        // Load Redis statistics
        async function loadRedisStats() {
            try {
                const response = await fetch('/api/redis/stats');
                if (!response.ok) {
                    // 503 means Redis is not connected
                    if (response.status === 503) {
                        document.getElementById('redis-stats').innerHTML =
                            '<div class="text-center text-yellow-400 py-8">‚ö†Ô∏è Redis not connected<br><span class="text-sm">Start the memory-cache server</span></div>';
                        return;
                    }
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const redisStats = await response.json();
                renderRedisStats(redisStats);
            } catch (error) {
                document.getElementById('redis-stats').innerHTML =
                    `<div class="text-center text-red-400 py-8">‚ùå Error loading Redis stats<br><span class="text-sm">${error.message}</span></div>`;
                console.error('Failed to load Redis stats:', error);
            }
        }

        // Modal management
        function showModal(modalId) {
            document.getElementById(modalId).classList.add('show');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        function showAddKeyModal() {
            document.getElementById('new-key-name').value = '';
            document.getElementById('new-key-value').value = '';
            document.getElementById('new-key-ttl').value = '';
            showModal('addKeyModal');
        }

        function showCreateGoalModal() {
            document.getElementById('new-goal-description').value = '';
            document.getElementById('new-goal-priority').value = 'medium';
            showModal('createGoalModal');
        }

        // Toast notification
        function showToast(message, type = 'info') {
            console.log('Showing toast:', message, type);

            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');

            if (!toast || !toastMessage) {
                console.error('Toast elements not found!');
                return;
            }

            toastMessage.textContent = message;

            // Add color based on type
            toast.className = 'fixed bottom-4 right-4 border rounded-lg p-4 shadow-lg min-w-64 max-w-md';
            if (type === 'success') {
                toast.className += ' bg-green-800 border-green-700 text-green-100';
            } else if (type === 'error') {
                toast.className += ' bg-red-800 border-red-700 text-red-100';
            } else if (type === 'warning') {
                toast.className += ' bg-yellow-800 border-yellow-700 text-yellow-100';
            } else {
                toast.className += ' bg-gray-800 border-gray-700 text-white';
            }
            toast.style.zIndex = '9999';
            toast.style.display = 'block';

            console.log('Toast displayed');

            // Auto-hide after delay
            const hideDelay = type === 'warning' ? 5000 : 3000;
            setTimeout(() => {
                toast.style.display = 'none';
                console.log('Toast hidden');
            }, hideDelay);
        }

        // Format uptime
        function formatUptime(seconds) {
            const days = Math.floor(seconds / 86400);
            const hours = Math.floor((seconds % 86400) / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);

            if (days > 0) return `${days}d ${hours}h`;
            if (hours > 0) return `${hours}h ${minutes}m`;
            return `${minutes}m`;
        }

        // Format memory
        function formatMemory(mb) {
            if (mb >= 1024) return `${(mb / 1024).toFixed(2)} GB`;
            return `${mb.toFixed(2)} MB`;
        }

        // Update status indicator
        function updateStatusIndicator(connected) {
            const indicator = document.getElementById('status-indicator');
            const statusText = document.getElementById('connection-status');

            if (connected) {
                indicator.classList.remove('status-stopped');
                indicator.classList.add('status-running');
                statusText.textContent = 'Connected';
            } else {
                indicator.classList.remove('status-running');
                indicator.classList.add('status-stopped');
                statusText.textContent = 'Disconnected';
            }
        }

        // Server Control Functions
        async function controlServer(serverKey, action) {
            try {
                const response = await fetch(`/api/servers/${serverKey}/control`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({action})
                });

                const result = await response.json();

                if (result.status === 'success') {
                    showToast(result.message, 'success');
                } else {
                    showToast(result.message || 'Operation failed', 'error');
                }

                setTimeout(refreshData, 1000);
            } catch (error) {
                showToast(`Failed to ${action} server: ${error.message}`, 'error');
            }
        }

        async function controlAllServers(action) {
            if (action === 'stop' && !confirm('Are you sure you want to stop all servers?')) {
                return;
            }

            try {
                const response = await fetch('/api/servers/control-all', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({action})
                });

                const result = await response.json();
                showToast(`Batch ${action} completed`, 'success');
                setTimeout(refreshData, 2000);
            } catch (error) {
                showToast(`Failed to ${action} servers: ${error.message}`, 'error');
            }
        }

        // Redis Functions
        async function loadRedisKeys(pattern = '*') {
            const container = document.getElementById('redis-keys-list');

            try {
                const response = await fetch(`/api/redis/keys?pattern=${encodeURIComponent(pattern)}&limit=100`);

                if (!response.ok) {
                    // Check if it's a Redis connection error (503)
                    if (response.status === 503) {
                        container.innerHTML = '<div class="text-center text-yellow-400 py-8">‚ö†Ô∏è Redis not connected<br><span class="text-sm">Start the memory-cache server</span></div>';
                        return;
                    }
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();

                if (!data.keys || data.keys.length === 0) {
                    container.innerHTML = '<div class="text-center text-gray-400 py-4">üì≠ No keys found<br><span class="text-sm">Redis is empty or no keys match pattern</span></div>';
                    return;
                }

                container.innerHTML = data.keys.map(key => `
                    <div class="bg-gray-700 rounded-lg p-3 flex justify-between items-center">
                        <div class="flex-1">
                            <div class="font-mono text-sm text-white">${key.key}</div>
                            <div class="text-xs text-gray-400 mt-1">
                                Type: ${key.type} | TTL: ${key.ttl === -1 ? 'No expiration' : key.ttl === -2 ? 'Expired' : key.ttl + 's'}
                            </div>
                        </div>
                        <div class="flex space-x-1">
                            <button onclick="viewKey('${key.key}')" class="btn btn-primary btn-sm">View</button>
                            <button onclick="confirmDeleteKey('${key.key}')" class="btn btn-danger btn-sm">Delete</button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                container.innerHTML = `<div class="text-center text-red-400 py-8">‚ùå Error loading Redis keys<br><span class="text-sm">${error.message}</span></div>`;
                console.error('Failed to load Redis keys:', error);
            }
        }

        function searchRedisKeys(event) {
            if (event.key === 'Enter') {
                const pattern = document.getElementById('redis-search').value || '*';
                loadRedisKeys(pattern);
            }
        }

        async function viewKey(key) {
            try {
                const response = await fetch(`/api/redis/key/${encodeURIComponent(key)}`);
                const data = await response.json();

                currentViewKey = key;
                document.getElementById('view-key-name').textContent = data.key;
                document.getElementById('view-key-type').textContent = data.type;
                document.getElementById('view-key-ttl').textContent =
                    data.ttl === -1 ? 'No expiration' : data.ttl === -2 ? 'Expired' : `${data.ttl} seconds`;
                document.getElementById('view-key-value').textContent =
                    typeof data.value === 'object' ? JSON.stringify(data.value, null, 2) : data.value;

                showModal('viewKeyModal');
            } catch (error) {
                showToast(`Failed to load key: ${error.message}`, 'error');
            }
        }

        async function addRedisKey() {
            const key = document.getElementById('new-key-name').value;
            const value = document.getElementById('new-key-value').value;
            const ttl = document.getElementById('new-key-ttl').value;

            if (!key || !value) {
                showToast('Key and value are required', 'error');
                return;
            }

            try {
                const response = await fetch('/api/redis/key', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        key,
                        value,
                        ttl: ttl ? parseInt(ttl) : null
                    })
                });

                const result = await response.json();
                showToast(result.message, 'success');
                closeModal('addKeyModal');
                loadRedisKeys();
            } catch (error) {
                showToast(`Failed to add key: ${error.message}`, 'error');
            }
        }

        function confirmDeleteKey(key) {
            if (confirm(`Delete key "${key}"?`)) {
                deleteKeyByName(key);
            }
        }

        async function deleteKey() {
            if (currentViewKey) {
                await deleteKeyByName(currentViewKey);
                closeModal('viewKeyModal');
            }
        }

        async function deleteKeyByName(key) {
            try {
                const response = await fetch(`/api/redis/key/${encodeURIComponent(key)}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                showToast(result.message, 'success');
                loadRedisKeys();
            } catch (error) {
                showToast(`Failed to delete key: ${error.message}`, 'error');
            }
        }

        function confirmFlushRedis() {
            if (confirm('WARNING: This will delete ALL Redis keys. Are you sure?')) {
                flushRedis();
            }
        }

        async function flushRedis() {
            try {
                const response = await fetch('/api/redis/flush', {method: 'POST'});
                const result = await response.json();
                showToast(result.message, 'success');
                loadRedisKeys();
                refreshData();
            } catch (error) {
                showToast(`Failed to flush Redis: ${error.message}`, 'error');
            }
        }

        // Goals Functions
        async function loadAllGoals() {
            const container = document.getElementById('all-goals-list');

            try {
                const response = await fetch('/api/goals/list');

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();

                // Successfully fetched, but no goals exist - this is OK!
                if (!data.goals || data.goals.length === 0) {
                    container.innerHTML = '<div class="text-center text-gray-400 py-4">üìã No goals yet<br><span class="text-sm">Click "Create Goal" to add one</span></div>';
                    return;
                }

                const statusColors = {
                    'pending': 'bg-gray-700 text-gray-300',
                    'in_progress': 'bg-blue-700 text-blue-300',
                    'completed': 'bg-green-700 text-green-300',
                    'cancelled': 'bg-red-700 text-red-300',
                };

                container.innerHTML = data.goals.map(goal => `
                    <div class="bg-gray-700 rounded-lg p-4 hover:bg-gray-650 transition-colors cursor-pointer" onclick="viewGoalDetails('${goal.id}')">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex-1">
                                <div class="text-sm font-medium text-white mb-1">${goal.description.substring(0, 100)}${goal.description.length > 100 ? '...' : ''}</div>
                                <div class="text-xs text-gray-400">
                                    Priority: ${goal.priority} | ${goal.tasks ? goal.tasks.length : 0} tasks | ID: ${goal.id}
                                </div>
                            </div>
                            <span class="px-2 py-1 rounded text-xs ${statusColors[goal.status] || statusColors.pending} ml-2 whitespace-nowrap">
                                ${goal.status}
                            </span>
                        </div>
                        <div class="flex space-x-1 mt-2" onclick="event.stopPropagation()">
                            <select class="px-2 py-1 bg-gray-600 rounded text-xs" onchange="updateGoalStatus('${goal.id}', this.value)">
                                <option value="">Change status...</option>
                                <option value="pending">Pending</option>
                                <option value="in_progress">In Progress</option>
                                <option value="completed">Completed</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                            <button onclick="confirmDeleteGoal('${goal.id}')" class="btn btn-danger btn-sm">Delete</button>
                            <button onclick="viewGoalDetails('${goal.id}')" class="btn btn-primary btn-sm">View Details</button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                container.innerHTML = `<div class="text-center text-red-400 py-8">‚ùå Error loading goals<br><span class="text-sm">${error.message}</span></div>`;
                console.error('Failed to load goals:', error);
            }
        }

        async function loadAllTasks() {
            const container = document.getElementById('all-tasks-list');

            try {
                const response = await fetch('/api/tasks/list');

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();

                // Successfully fetched, but no tasks exist - this is OK!
                if (!data.tasks || data.tasks.length === 0) {
                    container.innerHTML = '<div class="text-center text-gray-400 py-4">üìù No tasks yet<br><span class="text-sm">Tasks are created as part of goals</span></div>';
                    return;
                }

                const statusColors = {
                    'pending': 'bg-gray-700 text-gray-300',
                    'in_progress': 'bg-blue-700 text-blue-300',
                    'completed': 'bg-green-700 text-green-300',
                    'cancelled': 'bg-red-700 text-red-300',
                };

                container.innerHTML = data.tasks.map(task => `
                    <div class="bg-gray-700 rounded-lg p-3">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex-1">
                                <div class="text-sm text-white mb-1">${task.description.substring(0, 80)}${task.description.length > 80 ? '...' : ''}</div>
                                <div class="text-xs text-gray-400">
                                    ${task.dependencies ? task.dependencies.length : 0} dependencies
                                </div>
                            </div>
                            <span class="px-2 py-1 rounded text-xs ${statusColors[task.status] || statusColors.pending} ml-2 whitespace-nowrap">
                                ${task.status}
                            </span>
                        </div>
                        <div class="flex space-x-1">
                            <select class="px-2 py-1 bg-gray-600 rounded text-xs" onchange="updateTaskStatus('${task.id}', this.value)">
                                <option value="">Change status...</option>
                                <option value="pending">Pending</option>
                                <option value="in_progress">In Progress</option>
                                <option value="completed">Completed</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                            <button onclick="confirmDeleteTask('${task.id}')" class="btn btn-danger btn-sm">Delete</button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                container.innerHTML = `<div class="text-center text-red-400 py-8">‚ùå Error loading tasks<br><span class="text-sm">${error.message}</span></div>`;
                console.error('Failed to load tasks:', error);
            }
        }

        async function createGoal() {
            const description = document.getElementById('new-goal-description').value;
            const priority = document.getElementById('new-goal-priority').value;

            if (!description) {
                showToast('Description is required', 'error');
                return;
            }

            try {
                const response = await fetch('/api/goals', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({description, priority})
                });

                const result = await response.json();
                showToast('Goal created successfully', 'success');
                closeModal('createGoalModal');
                loadAllGoals();
                refreshData();
            } catch (error) {
                showToast(`Failed to create goal: ${error.message}`, 'error');
            }
        }

        async function viewGoalDetails(goalId) {
            try {
                const response = await fetch(`/api/goals/${goalId}`);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                const goal = data.goal;
                const tasks = data.tasks || [];
                const tasksByStatus = data.tasks_by_status || {};

                // Status colors
                const statusColors = {
                    'pending': 'bg-gray-700 text-gray-300',
                    'in_progress': 'bg-blue-700 text-blue-300',
                    'completed': 'bg-green-700 text-green-300',
                    'cancelled': 'bg-red-700 text-red-300',
                };

                const taskStatusColors = {
                    'pending': 'bg-gray-600 text-gray-300',
                    'in_progress': 'bg-blue-600 text-blue-300',
                    'completed': 'bg-green-600 text-green-300',
                    'cancelled': 'bg-red-600 text-red-300',
                };

                // Fill goal details
                document.getElementById('goal-detail-title').textContent = goal.description.substring(0, 60) + (goal.description.length > 60 ? '...' : '');
                document.getElementById('goal-detail-id').textContent = goal.id;
                document.getElementById('goal-detail-priority').textContent = goal.priority.toUpperCase();
                document.getElementById('goal-detail-created').textContent = new Date(goal.created_at).toLocaleString();
                document.getElementById('goal-detail-updated').textContent = new Date(goal.updated_at).toLocaleString();
                document.getElementById('goal-detail-description').textContent = goal.description;

                // Status badge
                const statusBadge = document.getElementById('goal-detail-status-badge');
                statusBadge.textContent = goal.status.replace('_', ' ').toUpperCase();
                statusBadge.className = `px-3 py-1 rounded text-sm ${statusColors[goal.status] || statusColors.pending}`;

                // Task counts
                document.getElementById('task-count-pending').textContent = tasksByStatus.pending || 0;
                document.getElementById('task-count-progress').textContent = tasksByStatus.in_progress || 0;
                document.getElementById('task-count-completed').textContent = tasksByStatus.completed || 0;
                document.getElementById('task-count-cancelled').textContent = tasksByStatus.cancelled || 0;

                // Tasks list
                const tasksContainer = document.getElementById('goal-detail-tasks');
                if (tasks.length === 0) {
                    tasksContainer.innerHTML = '<div class="text-center text-gray-400 py-4">No tasks for this goal</div>';
                } else {
                    tasksContainer.innerHTML = tasks.map((task, index) => `
                        <div class="bg-gray-700 rounded-lg p-3">
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex-1">
                                    <div class="text-sm font-medium text-white mb-1">
                                        ${index + 1}. ${task.description}
                                    </div>
                                    <div class="text-xs text-gray-400">
                                        ID: ${task.id} | Priority: ${task.priority}
                                        ${task.dependencies && task.dependencies.length > 0 ? ` | Depends on: ${task.dependencies.join(', ')}` : ''}
                                    </div>
                                    ${task.result ? `<div class="text-xs text-gray-300 mt-1">Result: ${task.result}</div>` : ''}
                                </div>
                                <span class="px-2 py-1 rounded text-xs ${taskStatusColors[task.status] || taskStatusColors.pending} ml-2 whitespace-nowrap">
                                    ${task.status.replace('_', ' ')}
                                </span>
                            </div>
                            ${task.completed_at ? `<div class="text-xs text-gray-400">Completed: ${new Date(task.completed_at).toLocaleString()}</div>` : ''}
                        </div>
                    `).join('');
                }

                showModal('viewGoalModal');
            } catch (error) {
                showToast(`Failed to load goal details: ${error.message}`, 'error');
                console.error('Failed to load goal details:', error);
            }
        }

        async function updateGoalStatus(goalId, status) {
            if (!status) return;

            try {
                const response = await fetch(`/api/goals/${goalId}`, {
                    method: 'PATCH',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({status})
                });

                showToast('Goal updated', 'success');
                loadAllGoals();
                refreshData();
            } catch (error) {
                showToast(`Failed to update goal: ${error.message}`, 'error');
            }
        }

        function confirmDeleteGoal(goalId) {
            if (confirm('Delete this goal and all its tasks?')) {
                deleteGoal(goalId);
            }
        }

        async function deleteGoal(goalId) {
            try {
                const response = await fetch(`/api/goals/${goalId}`, {method: 'DELETE'});
                const result = await response.json();
                showToast(result.message, 'success');
                loadAllGoals();
                loadAllTasks();
                refreshData();
            } catch (error) {
                showToast(`Failed to delete goal: ${error.message}`, 'error');
            }
        }

        async function updateTaskStatus(taskId, status) {
            if (!status) return;

            try {
                const response = await fetch(`/api/tasks/${taskId}`, {
                    method: 'PATCH',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({status})
                });

                showToast('Task updated', 'success');
                loadAllTasks();
                refreshData();
            } catch (error) {
                showToast(`Failed to update task: ${error.message}`, 'error');
            }
        }

        function confirmDeleteTask(taskId) {
            if (confirm('Delete this task?')) {
                deleteTask(taskId);
            }
        }

        async function deleteTask(taskId) {
            try {
                const response = await fetch(`/api/tasks/${taskId}`, {method: 'DELETE'});
                const result = await response.json();
                showToast(result.message, 'success');
                loadAllTasks();
                refreshData();
            } catch (error) {
                showToast(`Failed to delete task: ${error.message}`, 'error');
            }
        }

        // Environment Functions
        let currentEditEnvVar = null;

        async function loadEnvVariables() {
            const container = document.getElementById('env-list');

            try {
                const response = await fetch('/api/env');

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();

                // Successfully fetched - should always have server data
                if (!data.servers || Object.keys(data.servers).length === 0) {
                    container.innerHTML = '<div class="text-center text-gray-400 py-8">‚öôÔ∏è No servers configured</div>';
                    return;
                }

                container.innerHTML = Object.entries(data.servers).map(([key, server]) => {
                    const envVars = server.env_vars && Object.keys(server.env_vars).length > 0
                        ? Object.entries(server.env_vars).map(([name, info]) => {
                            const statusClass = info.configured ? 'text-green-400' : 'text-red-400';
                            const statusIcon = info.configured ? '‚úì' : '‚úó';
                            const displayValue = info.masked_value || 'Not set';

                            return `
                                <div class="flex justify-between items-center py-2 border-b border-gray-600">
                                    <span class="text-sm font-mono">${name}</span>
                                    <div class="flex items-center space-x-2">
                                        <span class="text-xs ${statusClass}">${statusIcon} ${info.configured ? 'Configured' : 'Not configured'}</span>
                                        <span class="text-xs text-gray-400 font-mono">${displayValue}</span>
                                        <button onclick="editEnvVariable('${name}')" class="btn btn-primary btn-sm">Edit</button>
                                    </div>
                                </div>
                            `;
                        }).join('')
                        : '<div class="text-xs text-gray-400">‚úì No environment variables required</div>';

                    return `
                        <div class="bg-gray-700 rounded-lg p-4">
                            <h3 class="text-sm font-bold text-white mb-3">${server.name}</h3>
                            ${envVars}
                        </div>
                    `;
                }).join('');
            } catch (error) {
                container.innerHTML = `<div class="text-center text-red-400 py-8">‚ùå Error loading environment config<br><span class="text-sm">${error.message}</span></div>`;
                console.error('Failed to load environment variables:', error);
            }
        }

        async function editEnvVariable(varName) {
            currentEditEnvVar = varName;

            try {
                // Fetch current value
                const response = await fetch(`/api/env/get/${varName}`);
                const data = await response.json();

                // Set modal fields
                document.getElementById('edit-env-name').textContent = varName;
                document.getElementById('edit-env-value').value = data.value || '';
                document.getElementById('edit-env-value').type = 'password';
                document.getElementById('eye-icon-open').classList.add('hidden');
                document.getElementById('eye-icon-closed').classList.remove('hidden');

                showModal('editEnvModal');
            } catch (error) {
                showToast(`Failed to load variable: ${error.message}`, 'error');
            }
        }

        function toggleEnvValueVisibility() {
            const input = document.getElementById('edit-env-value');
            const eyeOpen = document.getElementById('eye-icon-open');
            const eyeClosed = document.getElementById('eye-icon-closed');

            if (input.type === 'password') {
                input.type = 'text';
                eyeOpen.classList.remove('hidden');
                eyeClosed.classList.add('hidden');
            } else {
                input.type = 'password';
                eyeOpen.classList.add('hidden');
                eyeClosed.classList.remove('hidden');
            }
        }

        async function saveEnvVariable() {
            if (!currentEditEnvVar) {
                console.error('No current edit variable');
                return;
            }

            const value = document.getElementById('edit-env-value').value;

            if (!value.trim()) {
                showToast('‚ö†Ô∏è Value cannot be empty', 'error');
                return;
            }

            try {
                console.log('Saving env variable:', currentEditEnvVar);

                const response = await fetch('/api/env/update', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        variables: {
                            [currentEditEnvVar]: value
                        }
                    })
                });

                console.log('Response status:', response.status);

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || `HTTP ${response.status}`);
                }

                const result = await response.json();
                console.log('Save result:', result);

                // Close modal first
                closeModal('editEnvModal');

                // Show success message
                showToast(`‚úÖ ${result.message}`, 'success');

                // Reload environment variables
                await loadEnvVariables();

                // Show warning about restarting servers after a delay
                setTimeout(() => {
                    showToast('‚ö†Ô∏è Restart affected servers for changes to take effect', 'warning');
                }, 3000);

            } catch (error) {
                console.error('Error saving env variable:', error);
                showToast(`‚ùå Failed to save: ${error.message}`, 'error');
            }
        }

        // Log Functions
        async function downloadLogs() {
            const serverKey = document.getElementById('log-server-filter').value;

            if (serverKey === 'all') {
                showToast('Please select a specific server to download logs', 'error');
                return;
            }

            window.location.href = `/api/logs/download/${serverKey}`;
        }

        async function clearLogs() {
            const serverKey = document.getElementById('log-server-filter').value;

            if (serverKey === 'all') {
                showToast('Please select a specific server to clear logs', 'error');
                return;
            }

            if (!confirm(`Clear logs for ${serverKey}?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/logs/${serverKey}`, {method: 'DELETE'});
                const result = await response.json();
                showToast(result.message, 'success');
                refreshData();
            } catch (error) {
                showToast(`Failed to clear logs: ${error.message}`, 'error');
            }
        }


        // Render servers
        function renderServers(servers) {
            const container = document.getElementById('servers-list');

            if (servers.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-8">No servers configured</div>';
                return;
            }

            container.innerHTML = servers.map(server => {
                const statusClass = server.status === 'running' ? 'status-running' : 'status-stopped';
                const statusText = server.status === 'running' ? 'Running' : 'Stopped';
                const envClass = server.env_configured ? 'text-green-400' : 'text-yellow-400';

                let detailsHtml = '';
                if (server.status === 'running' && server.details) {
                    detailsHtml = `
                        <div class="text-xs text-gray-400 mt-2 space-y-1">
                            <div>PID: ${server.details.pid}</div>
                            <div>Uptime: ${formatUptime(server.details.uptime)}</div>
                            <div>Memory: ${formatMemory(server.details.memory_mb)}</div>
                        </div>
                    `;
                }

                // Control buttons
                let controlButtons = '';
                if (server.status === 'running') {
                    controlButtons = `
                        <button onclick="controlServer('${server.key}', 'restart')" class="btn btn-warning btn-sm">Restart</button>
                        <button onclick="controlServer('${server.key}', 'stop')" class="btn btn-danger btn-sm">Stop</button>
                    `;
                } else {
                    controlButtons = `
                        <button onclick="controlServer('${server.key}', 'start')" class="btn btn-success btn-sm">Start</button>
                    `;
                }

                return `
                    <div class="bg-gray-700 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center flex-1">
                                <span class="status-dot ${statusClass}"></span>
                                <span class="font-medium">${server.name}</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="px-2 py-1 rounded text-xs ${server.status === 'running' ? 'bg-green-900 text-green-300' : 'bg-red-900 text-red-300'}">
                                    ${statusText}
                                </span>
                                ${controlButtons}
                            </div>
                        </div>
                        <div class="text-xs ${envClass}">
                            ${server.env_configured ? '‚úì Environment configured' : '‚ö† Missing environment variables'}
                        </div>
                        ${detailsHtml}
                    </div>
                `;
            }).join('');
        }

        // Render Redis stats
        function renderRedisStats(stats) {
            const container = document.getElementById('redis-stats');

            container.innerHTML = `
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">Version</span>
                        <span class="font-medium">${stats.server.version}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">Uptime</span>
                        <span class="font-medium">${stats.server.uptime_days} days</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">Memory Used</span>
                        <span class="font-medium">${formatMemory(stats.memory.used_memory_mb)}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">Total Keys</span>
                        <span class="font-medium">${stats.total_keys.toLocaleString()}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">Connected Clients</span>
                        <span class="font-medium">${stats.clients.connected_clients}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">Ops/sec</span>
                        <span class="font-medium">${stats.stats.ops_per_sec.toLocaleString()}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">Hit Rate</span>
                        <span class="font-medium">
                            ${((stats.stats.keyspace_hits / (stats.stats.keyspace_hits + stats.stats.keyspace_misses) * 100) || 0).toFixed(1)}%
                        </span>
                    </div>
                </div>
            `;
        }

        // Render logs
        function renderLogs(data) {
            const container = document.getElementById('logs-container');
            const filter = document.getElementById('log-server-filter');

            // Update filter options
            if (data.all_servers) {
                const servers = Object.keys(data.all_servers);
                const currentValue = filter.value;

                filter.innerHTML = '<option value="all">All Servers</option>' +
                    servers.map(key => `<option value="${key}">${key}</option>`).join('');
                filter.value = currentValue;
            }

            // Get logs for selected server or all
            let logs = [];
            if (data.all_servers) {
                const selectedServer = filter.value;
                if (selectedServer === 'all') {
                    // Combine all logs
                    Object.keys(data.all_servers).forEach(key => {
                        const serverLogs = data.all_servers[key].map(log => ({
                            ...log,
                            server: key
                        }));
                        logs = logs.concat(serverLogs);
                    });
                } else if (data.all_servers[selectedServer]) {
                    logs = data.all_servers[selectedServer].map(log => ({
                        ...log,
                        server: selectedServer
                    }));
                }
            }

            if (logs.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-8">No logs available</div>';
                return;
            }

            // Display last 50 logs
            logs = logs.slice(-50);

            container.innerHTML = logs.map(log => {
                return `<div class="log-${log.level} mb-1"><span class="text-gray-500">[${log.server || 'system'}]</span> ${log.text}</div>`;
            }).join('');

            // Scroll to bottom
            container.scrollTop = container.scrollHeight;
        }

        // Handle log filter change
        document.getElementById('log-server-filter').addEventListener('change', () => {
            refreshData();
        });

        // Close modal on background click
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('show');
                }
            });
        });

        // Initialize page
        function initializeDashboard() {
            console.log('Initializing dashboard with WebSocket...');

            // Connect to WebSocket for real-time updates
            connectWebSocket();

            // Handle page visibility changes - reconnect if page becomes visible
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden && (!ws || ws.readyState !== WebSocket.OPEN)) {
                    console.log('Page visible and WebSocket not connected, reconnecting...');
                    connectWebSocket();
                }
            });
        }

        // Start dashboard
        initializeDashboard();

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (ws) {
                ws.close();
            }
            if (reconnectTimeout) {
                clearTimeout(reconnectTimeout);
            }
        });
    </script>
</body>
</html>
